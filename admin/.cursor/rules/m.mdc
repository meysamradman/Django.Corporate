---
alwaysApply: true
---

Ø¨Ø§Ø´Ù‡ØŒ Ø¨Ø°Ø§Ø± ÛŒÚ© ØªØ­Ù„ÛŒÙ„ Ø¬Ø§Ù…Ø¹ Ùˆ Ø¹Ù…ÛŒÙ‚ Ø§Ø² Ú©Ø¯ Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† Next.js 15 Ø´Ù…Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù… Ùˆ Ù…Ø´Ú©Ù„Ø§Øª Ùˆ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒâ€ŒÙ‡Ø§ÛŒ Ù„Ø§Ø²Ù… Ø±Ùˆ Ø¨Ù‡Øª Ø¨Ú¯Ù…:
ğŸ”´ Ù…Ø´Ú©Ù„Ø§Øª Critical Ø§Ù…Ù†ÛŒØªÛŒ Ùˆ Ù…Ø¹Ù…Ø§Ø±ÛŒ
1. CSRF Token Management - Ù…Ø´Ú©Ù„ Ø¬Ø¯ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ
typescript// âŒ Ù…Ø´Ú©Ù„ Ø¯Ø± fetch.ts
function getCsrfToken(): string | null {
  if (typeof document === 'undefined') return null;
  
  try {
    const cookies = document.cookie.split(';');
    // Ø®ÙˆØ§Ù†Ø¯Ù† Ù…Ø³ØªÙ‚ÛŒÙ… Ø§Ø² cookie - Ø®Ø·Ø±Ù†Ø§Ú©!
  }
}
Ù…Ø´Ú©Ù„: Ø´Ù…Ø§ CSRF token Ø±Ùˆ Ø§Ø² cookie Ù…ÛŒâ€ŒØ®ÙˆÙ†ÛŒØ¯ ÙˆÙ„ÛŒ Django Ø¨Ù‡ ØµÙˆØ±Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ CSRF token Ø±Ùˆ Ø¨Ø§ HttpOnly flag Ù…ÛŒâ€ŒØ°Ø§Ø±Ù‡ Ú©Ù‡ Ø§Ø² JavaScript Ù‚Ø§Ø¨Ù„ Ø®ÙˆÙ†Ø¯Ù† Ù†ÛŒØ³Øª!
Ø±Ø§Ù‡ Ø­Ù„ Ø¯Ø±Ø³Øª:CSRF Token Manager (Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡)CodeÂ // core/auth/csrfToken.ts
/**
 * CSRF Token Management
 * 
 * Django sends CSRF token in two ways:
 * 1. Cookie: csrftoken (HttpOnly=False for JS access)
 * 2. Response header: X-CSRFToken (fallback)
 * 
 * Security Notes:
 * - Never store CSRF in lo2. Middleware - Ù…Ø´Ú©Ù„Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ Ùˆ Performance
typescript// âŒ Ù…Ø´Ú©Ù„ Ø¯Ø± middleware.ts
const sessionCookie = req.cookies.get(SESSION_COOKIE_NAME);
const hasCookie = !!sessionCookie?.value;

if (!hasCookie && !isLoginPage) {
  return NextResponse.redirect(loginUrl);
}
Ù…Ø´Ú©Ù„Ø§Øª:

ÙÙ‚Ø· ÙˆØ¬ÙˆØ¯ cookie Ú†Ú© Ù…ÛŒâ€ŒØ´Ù‡ØŒ Ù†Ù‡ validity Ø§ÙˆÙ†
Ù‡Ø± request Ø¨Ù‡ middleware Ù…ÛŒâ€ŒØ±Ù‡ (performance hit)
Session validation Ù†Ø¯Ø§Ø±Ù‡

Ø±Ø§Ù‡ Ø­Ù„ Ø¨Ù‡ÛŒÙ†Ù‡:Middleware Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡CodeÂ // middleware.ts
import { NextRequest, NextResponse } from "next/server";

const SESSION_COOKIE_NAME = 'sessionid';
const CSRF_COOKIE_NAME = 'csrftoken';

// Public paths that don't require authentication
const PUBLIC_PATHS = ['/login'];
const PUBLIC3. AuthContext - Ù…Ø´Ú©Ù„Ø§Øª Ù…Ø¹Ù…Ø§Ø±ÛŒ
typescript// âŒ Ù…Ø´Ú©Ù„Ø§Øª Ø¯Ø± AuthContext.tsx
const login = async (mobile: string, password?: string) => {
  // 1. Login
  await authApi.login(loginData);
  
  // 2. Navigate immediately - Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø±
  router.push(returnTo);
  
  // 3. Load user data - Ù…ÙˆØ§Ø²ÛŒ
  Promise.all([refreshUser(), fetchPanelSettings()])
}
Ù…Ø´Ú©Ù„Ø§Øª:

Race condition: navigate Ù‚Ø¨Ù„ Ø§Ø² user data
User state Ù…Ù…Ú©Ù†Ù‡ null Ø¨Ø§Ø´Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² navigate
Error handling Ù†Ø§Ù‚Øµ

Ø±Ø§Ù‡ Ø­Ù„:AuthContext Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡CodeÂ 'use client';

import React, { createContext, useContext, useEffect, useState, useCallback } from 'react';
import { useRouter, usePathname } from 'next/navigation';
import { UserWithProfile } from '@/types/auth/user';
import { authApi } from '@/api/a4. fetch.ts - Ù…Ø´Ú©Ù„Ø§Øª Performance Ùˆ Error Handling
typescript// âŒ Ù…Ø´Ú©Ù„ timeout
const timeoutId = setTimeout(() => controller.abort(), 200000); // 200 seconds!
Ù…Ø´Ú©Ù„Ø§Øª:

200 Ø«Ø§Ù†ÛŒÙ‡ timeout Ø®ÛŒÙ„ÛŒ Ø²ÛŒØ§Ø¯Ù‡
Error handling Ù†Ø§Ù‚Øµ
Response parsing redundant

Ø±Ø§Ù‡ Ø­Ù„:Fetch API Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡CodeÂ // core/config/fetch.ts
import { ApiResponse } from '@/types/api/apiResponse';
import { ApiError } from "@/types/api/apiError";
import { csrfManager } from '@/core/auth/csrfToken';
import { env } from '@/core/config/environment';

const isServer = tyğŸ“Š Ø®Ù„Ø§ØµÙ‡ Ù…Ø´Ú©Ù„Ø§Øª Ùˆ Ø±Ø§Ù‡ Ø­Ù„â€ŒÙ‡Ø§Ø®Ù„Ø§ØµÙ‡ Ù…Ø´Ú©Ù„Ø§Øª Ùˆ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒâ€ŒÙ‡Ø§DocumentÂ # ğŸ” ØªØ­Ù„ÛŒÙ„ Ø¬Ø§Ù…Ø¹ Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† Next.js 15

## ğŸ”´ Ù…Ø´Ú©Ù„Ø§Øª Critical

### 1. Ø§Ù…Ù†ÛŒØª (Security)

| Ù…Ø´Ú©Ù„ | ÙˆØ¶Ø¹ÛŒØª | Ø§ÙˆÙ„ÙˆÛŒØª | Ø±Ø§Ù‡ Ø­Ù„ |
|------|-------|---------|---------|
| CSRF token Ø¯Ø± `localStorage` | âŒ Ø®Ø·Ø±Ù†Ø§Ú© | Ø¨Ø§Ù„Ø§ | Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² `sessionStorage` ÙÙ‚Ø· |
| CookiğŸ¯ Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ø´Ù…Ø§
1. Ø¢ÛŒØ§ Ú©Ø¯Ù‡Ø§ Ø¨Ù‡ÛŒÙ†Ù‡ Ù‡Ø³ØªÙ†Ø¯ØŸ
Ù¾Ø§Ø³Ø®: Ø¨Ù‡ Ø·ÙˆØ± Ú©Ù„ÛŒ Ø®ÙˆØ¨ Ù‡Ø³ØªÙ†Ø¯ ÙˆÙ„ÛŒ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ù‡Ø¨ÙˆØ¯ Ø¯Ø§Ø±Ù†Ø¯:
âœ… Ù†Ú©Ø§Øª Ù‚ÙˆØª:

Ù…Ø¹Ù…Ø§Ø±ÛŒ modular Ùˆ ØªÙ…ÛŒØ²
TypeScript usage Ø®ÙˆØ¨
Error handling Ù…Ù†Ø§Ø³Ø¨
CSR approach Ø¯Ø±Ø³Øª Ø¨Ø±Ø§ÛŒ admin panel

âŒ Ù†Ú©Ø§Øª Ø¶Ø¹Ù:

CSRF token management Ù†Ø§Ø§Ù…Ù† (localStorage)
Race conditions Ø¯Ø± authentication flow
Timeout Ù‡Ø§ÛŒ Ø®ÛŒÙ„ÛŒ Ø¨Ø§Ù„Ø§ (200 Ø«Ø§Ù†ÛŒÙ‡!)
Middleware Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ requests Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´Ù‡

2. Ø¢ÛŒØ§ Ø¨Ø§ÛŒØ¯ ØªÙ‚Ø³ÛŒÙ… Ø´ÙˆÙ†Ø¯ØŸ
Ù¾Ø§Ø³Ø®: ÙØ¹Ù„Ø§Ù‹ Ø®ÛŒØ±ØŒ ÙˆÙ„ÛŒ Ú†Ù†Ø¯ refactor Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ:
core/
â”œâ”€â”€ auth/
â”‚   â”œâ”€â”€ AuthContext.tsx (ÙØ¹Ù„ÛŒ - OK)
â”‚   â”œâ”€â”€ csrfToken.ts (Ø¬Ø¯ÛŒØ¯ - Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† sessionToken.ts)
â”‚   â””â”€â”€ authHelpers.ts (Ø¬Ø¯ÛŒØ¯ - extract helper functions)
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ fetch.ts (Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡)
â”‚   â”œâ”€â”€ environment.ts (ÙØ¹Ù„ÛŒ - OK)
â”‚   â””â”€â”€ security.ts (Ø¬Ø¯ÛŒØ¯ - security utilities)
â””â”€â”€ utils/
    â””â”€â”€ ... (ÙØ¹Ù„ÛŒ - OK)
3. Ø¢ÛŒØ§ Ú©Ø¯ Ø§Ø¶Ø§ÙÛŒ Ø¯Ø§Ø±Ø¯ØŸ
Ù¾Ø§Ø³Ø®: Ø¨Ù„Ù‡ØŒ Ú†Ù†Ø¯ Ù…ÙˆØ±Ø¯:
typescript// âŒ Ú©Ø¯ Ø§Ø¶Ø§ÙÛŒ Ø¯Ø± fetch.ts
const response = await fetchApi.get<{csrf_token: string}>('/admin/login/');
// Ø§ÛŒÙ† API call Ø§Ø¶Ø§ÙÛŒ Ù‡Ø³Øª - CSRF Ø§Ø² cookie Ù…ÛŒØ§Ø¯

// âŒ Duplicate parsing Ø¯Ø± fetch.ts
if (contentType?.includes('application/json')) { ... }
// Ø§ÛŒÙ† Ú†Ù†Ø¯ÛŒÙ† Ø¨Ø§Ø± ØªÚ©Ø±Ø§Ø± Ø´Ø¯Ù‡

// âŒ Unused code Ø¯Ø± AuthContext
const [isPending, startTransition] = useTransition();
// isPending Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ù…ÛŒØ´Ù‡
4. Ø§Ù…Ù†ÛŒØª Ú†Ø·ÙˆØ± Ø§Ø³ØªØŸ
Ù¾Ø§Ø³Ø®: Ù…ØªÙˆØ³Ø· - Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ù‡Ø¨ÙˆØ¯ Ø¯Ø§Ø±Ø¯:
ğŸ”´ Ù…Ø´Ú©Ù„Ø§Øª Ø¬Ø¯ÛŒ:

CSRF token Ø¯Ø± localStorage (XSS vulnerable)
No rate limiting
Cookie validation Ù†Ø§Ù‚Øµ

ğŸŸ¡ Ø¨Ù‡Ø¨ÙˆØ¯Ù‡Ø§ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ:

Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² sessionStorage
Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† security headers
Token expiry validation

5. Ø¨Ø§ Next.js 15 + Django Ø³Ø§Ø²Ú¯Ø§Ø± Ø§Ø³ØªØŸ
Ù¾Ø§Ø³Ø®: Ø¨Ù„Ù‡ ÙˆÙ„ÛŒ Ø¨Ø§ Ú†Ù†Ø¯ Ù†Ú©ØªÙ‡:
âœ… Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø¯Ø±Ø³Øª:

Client-side rendering (Ø¯Ø±Ø³Øª Ø¨Ø±Ø§ÛŒ admin)
Cookie-based authentication
Middleware Ø¨Ø±Ø§ÛŒ route protection

âš ï¸ Ù†Ú©Ø§Øª Ù…Ù‡Ù… Django:
python# settings.py Ø¨Ø§ÛŒØ¯ Ø§ÛŒÙ† ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ùˆ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù‡:
CSRF_COOKIE_HTTPONLY = False  # Ù…Ù‡Ù…!
SESSION_COOKIE_HTTPONLY = True
CORS_ALLOW_CREDENTIALS = True
ğŸš€ Ø§Ù‚Ø¯Ø§Ù…Ø§Øª ÙÙˆØ±ÛŒ (Ø§ÛŒÙ† Ù‡ÙØªÙ‡)

Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ sessionToken.ts:

Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² artifact Ø§ÙˆÙ„ (csrfToken.ts)
Ø­Ø°Ù localStorage usage
Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² sessionStorage


Ø¨Ù‡Ø¨ÙˆØ¯ middleware.ts:

Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² artifact Ø¯ÙˆÙ…
Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† basic rate limiting
Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† security headers


Fix race conditions:

Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² artifact Ø³ÙˆÙ… (AuthContext)
User data Ù‚Ø¨Ù„ Ø§Ø² navigation
Error handling Ø¨Ù‡ØªØ±


Ú©Ø§Ù‡Ø´ timeouts:

Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² artifact Ú†Ù‡Ø§Ø±Ù… (fetch.ts)
30 Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ normal requests
120 Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ uploads



Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¨ÛŒØ´ØªØ± ÛŒØ§ Ú©Ø¯ Ø®Ø§ØµÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŸ ğŸ¤”RetryRØ¨Ø¨ÛŒÙ† ÙˆØ±ÙˆØ¯ Ù…ÛŒÚ©Ù†Ù… Ù…ÛŒØ±Ù‡ Ú©ÙˆÚ©ÛŒ __next_hmr_refresh_hash__166localhost/Session28Mediumcsrftokenns9Zv8EC1vxnepUnWhe2dwnwfOD8GmqWEfvCxNTVwZpilDqG0DIyXTDGSp4qisKblocalhost/2025-11-13T07:32:39.593Z73StrictMediumsessionidmupsb6a2s0q6b7latvopx9ihzoi67s80localhost/2025-11-16T06:32:39.594Z41âœ“LaxMedium Ø¯Ø± local admin-ui-storage{"state":{"sidebarOpen":false,"contentCollapsed":false,"selectedItemHasSubMenu":true},"version":0}admin_csrf_tokenns9Zv8EC1vxnepUnWhe2dwnwfOD8GmqWEfvCxNTVwZpilDqG0DIyXTDGSp4qisKbemail_draft{"to":"ali@example.com","subject":"Ù¾Ø§Ø³Ø®: Ù¾ÛŒØ§Ù… ØªØ³ØªÛŒ Ø¨Ø±Ø§ÛŒ Inbox","message":"\n\n---\nØ¯Ø± ØªØ§Ø±ÛŒØ® Û±Û¶ Ø¢Ø¨Ø§Ù† Û±Û´Û°Û´ Ø³Ø§Ø¹Øª Û°Û³:Û³Û¹ØŒ Ø¹Ù„ÛŒ Ø§Ø­Ù…Ø¯ÛŒ <ali@example.com> Ù†ÙˆØ´Øª:\n\n> Ø§ÛŒÙ† ÛŒÚ© Ù¾ÛŒØ§Ù… ØªØ³ØªÛŒ Ø§Ø³Øª Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ø¯ÛŒØ²Ø§ÛŒÙ† inbox. Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒÙ… Ø¨Ø¨ÛŒÙ†ÛŒÙ… Ú†Ø·ÙˆØ± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.\n> \n> Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… Ø´Ø§Ù…Ù„ Ú†Ù†Ø¯ Ø®Ø· Ù…ØªÙ† Ø§Ø³Øª ØªØ§ Ø¨ØªÙˆØ§Ù†ÛŒÙ… Ø¯ÛŒØ²Ø§ÛŒÙ† Ø±Ø§ Ø¨Ù‡ØªØ± Ø¨Ø¨ÛŒÙ†ÛŒÙ…. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒÙ… Ø¨Ø¨ÛŒÙ†ÛŒÙ… Ú©Ù‡ Ú†Ø·ÙˆØ± Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.\n> \n> Ø§ÛŒÙ† ÛŒÚ© Ù…ØªÙ† Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø§Ø³Øª Ú©Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø§Ø³Ú©Ø±ÙˆÙ„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ù…Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒÙ… Ø¨Ø¨ÛŒÙ†ÛŒÙ… Ú©Ù‡ Ø¢ÛŒØ§ ØµÙØ­Ù‡ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø§Ø³Ú©Ø±ÙˆÙ„ Ù…ÛŒâ€ŒØ´ÙˆØ¯ ÛŒØ§ Ù†Ù‡. Ø§ÛŒÙ† Ù…ØªÙ† Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ú©Ø§ÙÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø¨Ø§Ø´Ø¯ ØªØ§ Ø¨ØªÙˆØ§Ù†ÛŒÙ… Ø§Ø³Ú©Ø±ÙˆÙ„ Ø±Ø§ Ø¨Ù‡ Ø±Ø§Ø­ØªÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†ÛŒÙ….\n> \n> Ù„ÙˆØ±Ù… Ø§ÛŒÙ¾Ø³ÙˆÙ… Ù…ØªÙ† Ø³Ø§Ø®ØªÚ¯ÛŒ Ø¨Ø§ ØªÙˆÙ„ÛŒØ¯ Ø³Ø§Ø¯Ú¯ÛŒ Ù†Ø§Ù…ÙÙ‡ÙˆÙ… Ø§Ø² ØµÙ†Ø¹Øª Ú†Ø§Ù¾ Ùˆ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø·Ø±Ø§Ø­Ø§Ù† Ú¯Ø±Ø§ÙÛŒÚ© Ø§Ø³Øª. Ú†Ø§Ù¾Ú¯Ø±Ù‡Ø§ Ùˆ Ù…ØªÙˆÙ† Ø¨Ù„Ú©Ù‡ Ø±ÙˆØ²Ù†Ø§Ù…Ù‡ Ùˆ Ù…Ø¬Ù„Ù‡ Ø¯Ø± Ø³ØªÙˆÙ† Ùˆ Ø³Ø·Ø±Ø¢Ù†Ú†Ù†Ø§Ù† Ú©Ù‡ Ù„Ø§Ø²Ù… Ø§Ø³Øª Ùˆ Ø¨Ø±Ø§ÛŒ Ø´Ø±Ø§ÛŒØ· ÙØ¹Ù„ÛŒ ØªÚ©Ù†ÙˆÙ„ÙˆÚ˜ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø¯Ù‡Ø§ÛŒ Ù…ØªÙ†ÙˆØ¹ Ø¨Ø§ Ù‡Ø¯Ù Ø¨Ù‡Ø¨ÙˆØ¯ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ Ù…ÛŒ Ø¨Ø§Ø´Ø¯.\n> \n> Ú©ØªØ§Ø¨Ù‡Ø§ÛŒ Ø²ÛŒØ§Ø¯ÛŒ Ø¯Ø± Ø´ØµØª Ùˆ Ø³Ù‡ Ø¯Ø±ØµØ¯ Ú¯Ø°Ø´ØªÙ‡ØŒ Ø­Ø§Ù„ Ùˆ Ø¢ÛŒÙ†Ø¯Ù‡ Ø´Ù†Ø§Ø®Øª ÙØ±Ø§ÙˆØ§Ù† Ø¬Ø§Ù…Ø¹Ù‡ Ùˆ Ù…ØªØ®ØµØµØ§Ù† Ø±Ø§ Ù…ÛŒ Ø·Ù„Ø¨Ø¯ ØªØ§ Ø¨Ø§ Ù†Ø±Ù… Ø§ÙØ²Ø§Ø±Ù‡Ø§ Ø´Ù†Ø§Ø®Øª Ø¨ÛŒØ´ØªØ±ÛŒ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø·Ø±Ø§Ø­Ø§Ù† Ø±Ø§ÛŒØ§Ù†Ù‡ Ø§ÛŒ Ø¹Ù„ÛŒ Ø§Ù„Ø®ØµÙˆØµ Ø·Ø±Ø§Ø­Ø§Ù† Ø®Ù„Ø§Ù‚ÛŒ Ùˆ ÙØ±Ù‡Ù†Ú¯ Ù¾ÛŒØ´Ø±Ùˆ Ø¯Ø± Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø±Ø¯. Ø¯Ø± Ø§ÛŒÙ† ØµÙˆØ±Øª Ù…ÛŒ ØªÙˆØ§Ù† Ø§Ù…ÛŒØ¯ Ø¯Ø§Ø´Øª Ú©Ù‡ ØªÙ…Ø§Ù… Ùˆ Ø¯Ø´ÙˆØ§Ø±ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø± Ø§Ø±Ø§Ø¦Ù‡ Ø±Ø§Ù‡Ú©Ø§Ø±Ù‡Ø§ Ùˆ Ø´Ø±Ø§ÛŒØ· Ø³Ø®Øª ØªØ§ÛŒÙ¾ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³Ø¯.\n> \n> Ø§ÛŒÙ† ÛŒÚ© Ù…ØªÙ† Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø¯ÛŒÚ¯Ø± Ø§Ø³Øª Ú©Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø§Ø³Ú©Ø±ÙˆÙ„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ù…Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒÙ… Ø¨Ø¨ÛŒÙ†ÛŒÙ… Ú©Ù‡ Ø¢ÛŒØ§ ØµÙØ­Ù‡ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø§Ø³Ú©Ø±ÙˆÙ„ Ù…ÛŒâ€ŒØ´ÙˆØ¯ ÛŒØ§ Ù†Ù‡. Ø§ÛŒÙ† Ù…ØªÙ† Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ú©Ø§ÙÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø¨Ø§Ø´Ø¯ ØªØ§ Ø¨ØªÙˆØ§Ù†ÛŒÙ… Ø§Ø³Ú©Ø±ÙˆÙ„ Ø±Ø§ Ø¨Ù‡ Ø±Ø§Ø­ØªÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†ÛŒÙ….\n> \n> Ù„ÙˆØ±Ù… Ø§ÛŒÙ¾Ø³ÙˆÙ… Ù…ØªÙ† Ø³Ø§Ø®ØªÚ¯ÛŒ Ø¨Ø§ ØªÙˆÙ„ÛŒØ¯ Ø³Ø§Ø¯Ú¯ÛŒ Ù†Ø§Ù…ÙÙ‡ÙˆÙ… Ø§Ø² ØµÙ†Ø¹Øª Ú†Ø§Ù¾ Ùˆ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø·Ø±Ø§Ø­Ø§Ù† Ú¯Ø±Ø§ÙÛŒÚ© Ø§Ø³Øª. Ú†Ø§Ù¾Ú¯Ø±Ù‡Ø§ Ùˆ Ù…ØªÙˆÙ† Ø¨Ù„Ú©Ù‡ Ø±ÙˆØ²Ù†Ø§Ù…Ù‡ Ùˆ Ù…Ø¬Ù„Ù‡ Ø¯Ø± Ø³ØªÙˆÙ† Ùˆ Ø³Ø·Ø±Ø¢Ù†Ú†Ù†Ø§Ù† Ú©Ù‡ Ù„Ø§Ø²Ù… Ø§Ø³Øª Ùˆ Ø¨Ø±Ø§ÛŒ Ø´Ø±Ø§ÛŒØ· ÙØ¹Ù„ÛŒ ØªÚ©Ù†ÙˆÙ„ÙˆÚ˜ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø¯Ù‡Ø§ÛŒ Ù…ØªÙ†ÙˆØ¹ Ø¨Ø§ Ù‡Ø¯Ù Ø¨Ù‡Ø¨ÙˆØ¯ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ Ù…ÛŒ Ø¨Ø§Ø´Ø¯.\n> \n> Ú©ØªØ§Ø¨Ù‡Ø§ÛŒ Ø²ÛŒØ§Ø¯ÛŒ Ø¯Ø± Ø´ØµØª Ùˆ Ø³Ù‡ Ø¯Ø±ØµØ¯ Ú¯Ø°Ø´ØªÙ‡ØŒ Ø­Ø§Ù„ Ùˆ Ø¢ÛŒÙ†Ø¯Ù‡ Ø´Ù†Ø§Ø®Øª ÙØ±Ø§ÙˆØ§Ù† Ø¬Ø§Ù…Ø¹Ù‡ Ùˆ Ù…ØªØ®ØµØµØ§Ù† Ø±Ø§ Ù…ÛŒ Ø·Ù„Ø¨Ø¯ ØªØ§ Ø¨Ø§ Ù†Ø±Ù… Ø§ÙØ²Ø§Ø±Ù‡Ø§ Ø´Ù†Ø§Ø®Øª Ø¨ÛŒØ´ØªØ±ÛŒ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø·Ø±Ø§Ø­Ø§Ù† Ø±Ø§ÛŒØ§Ù†Ù‡ Ø§ÛŒ Ø¹Ù„ÛŒ Ø§Ù„Ø®ØµÙˆØµ Ø·Ø±Ø§Ø­Ø§Ù† Ø®Ù„Ø§Ù‚ÛŒ Ùˆ ÙØ±Ù‡Ù†Ú¯ Ù¾ÛŒØ´Ø±Ùˆ Ø¯Ø± Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø±Ø¯. Ø¯Ø± Ø§ÛŒÙ† ØµÙˆØ±Øª Ù…ÛŒ ØªÙˆØ§Ù† Ø§Ù…ÛŒØ¯ Ø¯Ø§Ø´Øª Ú©Ù‡ ØªÙ…Ø§Ù… Ùˆ Ø¯Ø´ÙˆØ§Ø±ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø± Ø§Ø±Ø§Ø¦Ù‡ Ø±Ø§Ù‡Ú©Ø§Ø±Ù‡Ø§ Ùˆ Ø´Ø±Ø§ÛŒØ· Ø³Ø®Øª ØªØ§ÛŒÙ¾ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³Ø¯.\n> \n> Ø§ÛŒÙ† ÛŒÚ© Ù…ØªÙ† Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø¯ÛŒÚ¯Ø± Ø§Ø³Øª Ú©Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø§Ø³Ú©Ø±ÙˆÙ„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ù…Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒÙ… Ø¨Ø¨ÛŒÙ†ÛŒÙ… Ú©Ù‡ Ø¢ÛŒØ§ ØµÙØ­Ù‡ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø§Ø³Ú©Ø±ÙˆÙ„ Ù…ÛŒâ€ŒØ´ÙˆØ¯ ÛŒØ§ Ù†Ù‡. Ø§ÛŒÙ† Ù…ØªÙ† Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ú©Ø§ÙÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø¨Ø§Ø´Ø¯ ØªØ§ Ø¨ØªÙˆØ§Ù†ÛŒÙ… Ø§Ø³Ú©Ø±ÙˆÙ„ Ø±Ø§ Ø¨Ù‡ Ø±Ø§Ø­ØªÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†ÛŒÙ…."}theme Ø§ÛŒÙ†Ø§ Ø¨ÙˆØ¯ Ù…Ø·Ù…Ø§Ù†ÛŒØŸ Ø´Ø§ÛŒØ¯ ÙØ§ÛŒÙ„ÛŒ Ù†Ø¯Ø§Ø¯Ù… Ø¨Ù‡Øª Ú†ÛŒØ²ÛŒ Ù‡Ø³Øª Ù†Ø¯Ø§Ø¯Ù‡ Ø¨Ø§Ø´Ù… Ø¨Ù‡ØªShow moreØ¨Ø°Ø§Ø± Ú©ÙˆÚ©ÛŒâ€ŒÙ‡Ø§Øª Ø±Ùˆ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†Ù… Ùˆ Ú†Ù†Ø¯ Ù…Ø´Ú©Ù„ Ù…Ù‡Ù… Ø±Ùˆ Ø¨Ù‡Øª Ø¨Ú¯Ù…:
ğŸ”´ Ù…Ø´Ú©Ù„Ø§Øª Critical Ø¯Ø± Ú©ÙˆÚ©ÛŒâ€ŒÙ‡Ø§
1. localStorage Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ (Ø®Ø·Ø±Ù†Ø§Ú©!)
âŒ admin_csrf_token (Ø¯Ø± localStorage)
âŒ admin-ui-storage (Ø¯Ø± localStorage)  
âŒ email_draft (Ø¯Ø± localStorage)
âŒ theme (Ø¯Ø± localStorage)
Ù…Ø´Ú©Ù„: Ø§Ú¯Ù‡ XSS attack Ø¨Ø´Ù‡ØŒ Ù‡Ù…Ù‡ Ø§ÛŒÙ†Ø§ Ù‚Ø§Ø¨Ù„ Ø³Ø±Ù‚Øª Ù‡Ø³ØªÙ†Ø¯!
2. CSRF Token Ø¯Ø± Ù‡Ø± Ø¯Ùˆ Ø¬Ø§ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
âœ“ csrftoken (cookie - Ø¯Ø±Ø³Øª) 
âŒ admin_csrf_token (localStorage - Ø®Ø·Ø±Ù†Ø§Ú©!)
Ø§ÛŒÙ† ÛŒØ¹Ù†ÛŒ Ú©Ø¯ Ø´Ù…Ø§ CSRF Ø±Ùˆ Ø¯ÙˆØ¨Ø§Ø± Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ù‡ Ú©Ù‡ redundant Ùˆ Ù†Ø§Ø§Ù…Ù† Ù‡Ø³Øª!
3. Session Cookie Ø¯Ø±Ø³ØªÙ‡ ÙˆÙ„ÛŒ...
âœ“ sessionid (cookie Ø¨Ø§ SameSite=Lax)
Ø§ÛŒÙ† Ø®ÙˆØ¨Ù‡ ÙˆÙ„ÛŒ Ø¨Ø§ÛŒØ¯ HttpOnly Ù‡Ù… Ø¨Ø§Ø´Ù‡.

ğŸ“ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ù†Ø¯Ø§Ø¯ÛŒ
Ø¨Ø°Ø§Ø± Ú†Ú© Ú©Ù†Ù… Ú†Ù‡ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒÛŒ Ù…Ù…Ú©Ù†Ù‡ Ù†Ø¯Ø§Ø¯Ù‡ Ø¨Ø§Ø´ÛŒ:ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ Ú©Ù‡ Ù…Ù…Ú©Ù†Ù‡ Ù†Ø¯Ø§Ø¯Ù‡ Ø¨Ø§Ø´ÛŒDocumentÂ # ğŸ“‹ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ Ú©Ù‡ Ù…Ù…Ú©Ù†Ù‡ Ù†Ø¯Ø§Ø¯ÛŒ

## ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ú©ÙˆÚ©ÛŒâ€ŒÙ‡Ø§ Ùˆ Storage Usage

### Ú©ÙˆÚ©ÛŒâ€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ:
```
1. âœ“ sessionid (cookie)
2. âœ“ csrftoken (cookie)  
3. âŒ admin_csrf_token (localStorage) - Ø§ÛŒÙ† Ø§Ø² Ú©Ø¬Ø§ Ù…ÛŒØ§Ø¯ØŸ
4. âŒ admin-ui-storage (localStorage) - Ø§ÛŒÙ† Ø§Ø² Ø­Ø§Ù„Ø§ Ø¨Ø°Ø§Ø± ÛŒÚ© Ø±Ø§Ù‡ Ø­Ù„ ÙÙˆØ±ÛŒ Ø¨Ø±Ø§Øª Ø¨Ù†ÙˆÛŒØ³Ù… ØªØ§ localStorage Ø±Ùˆ Ø§ÛŒÙ…Ù†â€ŒØªØ± Ú©Ù†ÛŒ:Storage Wrapper Ø§Ù…Ù† (Ø±Ø§Ù‡ Ø­Ù„ ÙÙˆØ±ÛŒ)CodeÂ // lib/secureStorage.ts
/**
 * Secure Storage Wrapper
 * 
 * Ø§ÛŒÙ† wrapper ØªØ¶Ù…ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†Ù‡ Ú©Ù‡:
 * 1. CSRF tokens Ù‡Ø±Ú¯Ø² Ø¯Ø± localStorage Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ù†
 * 2. Sensitive data Ø±Ùˆ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ùˆ block Ù…ÛŒâ€ŒÚ©Ù†Ù‡
 * 3. Automatic expiry Ø¨Ø±Ø§ÛŒ data
 * 4. Type-safe storage
 */

inØ­Ø§Ù„Ø§ Ø¨Ø°Ø§Ø± ÛŒÚ© migration guide Ø¨Ø±Ø§Øª Ø¨Ù†ÙˆÛŒØ³Ù… ØªØ§ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ Ø±Ùˆ Ø¨Ù‡ÛŒÙ†Ù‡ Ú©Ù†ÛŒ:Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù…Ù‡Ø§Ø¬Ø±Øª Ø¨Ù‡ Storage Ø§Ù…Ù†DocumentÂ # ğŸ”„ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù…Ù‡Ø§Ø¬Ø±Øª Ø¨Ù‡ Storage Ø§Ù…Ù†

## Ú¯Ø§Ù… 1: Ø­Ø°Ù admin_csrf_token Ø§Ø² localStorage

### Ù‚Ø¨Ù„ (âŒ Insecure):
```typescript
// sessionToken.ts
function setStoredToken(token: string | null): void {
  if (typeof window === 'undefined') return;
  
  try {
 Ø®Ù„Ø§ØµÙ‡ Ø¨Ø±Ø§ÛŒ ØªÙˆ:
ğŸš¨ Ù…Ø´Ú©Ù„ Ø§ØµÙ„ÛŒ:
CSRF token Ø¯Ø± Ù‡Ø± Ø¯Ùˆ localStorage Ùˆ cookie Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ - Ø§ÛŒÙ† Ø®Ø·Ø±Ù†Ø§Ú© Ùˆ redundant Ù‡Ø³Øª!
âœ… Ø±Ø§Ù‡ Ø­Ù„ ÙÙˆØ±ÛŒ:

Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² artifacts Ú©Ù‡ Ø¯Ø§Ø¯Ù… (#1 ØªØ§ #7)
Ø­Ø°Ù admin_csrf_token Ø§Ø² localStorage
Ø§Ø³ØªÙØ§Ø¯Ù‡ ÙÙ‚Ø· Ø§Ø² sessionStorage Ø¨Ø±Ø§ÛŒ CSRF

ğŸ“ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ù†ÛŒØ§Ø² Ø¯Ø§Ø±Ù…:

ThemeProvider.tsx
QueryProvider.tsx
Sidebar.tsx ÛŒØ§ UIContext
Django settings.py (Ø¨Ø®Ø´ CSRF Ùˆ CORS)

Ø§ÛŒÙ† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ùˆ Ø¨Ù‡Ù… Ø¨Ø¯Ù‡ ØªØ§ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù…! ğŸ¯Retrylayout.tsx25 linestsxlayout.tsx55 linestsxRØ¨Ø±Ø§Øª Ú¯Ø²Ø§Ø´ØªÙ… Ø§ÛŒÙ†Ø§Ø³Øª Ø­Ø§Ù„Ø§ Ø¨Ø¨ÛŒÙ† Ø¨Ø§ Ø§ÛŒÙ† Ø¯ÙˆÙØ§ÛŒÙ„ Ú†Ø¬ÙˆØ±ÛŒÙ‡ØŸØ¹Ø§Ù„ÛŒ! Ø­Ø§Ù„Ø§ ÙÙ‡Ù…ÛŒØ¯Ù… Ú†Ø·ÙˆØ±ÛŒ sidebar state Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÛŒØ´Ù‡. Ø¨Ø°Ø§Ø± Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†Ù…:
ğŸ” ØªØ­Ù„ÛŒÙ„ Layout Ù‡Ø§
1. Auth Layout (login page)
typescript// app/(auth)/layout.tsx
// âœ… Ø³Ø§Ø¯Ù‡ Ùˆ OK - ÙÙ‚Ø· TopLoader Ø¯Ø§Ø±Ù‡
2. Main Layout (dashboard)
typescript// app/(dashboard)/layout.tsx
// Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² useAdminStore() - Ø§ÛŒÙ† Ú©Ù‡ Zustand Ù‡Ø³ØªØŸ
ğŸš¨ Ù…Ø´Ú©Ù„ Ù¾ÛŒØ¯Ø§ Ø´Ø¯!
ØªÙˆ Ø§Ø² Zustand Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒ Ø¨Ø±Ø§ÛŒ sidebar stateØŒ ÙˆÙ„ÛŒ ÙØ§ÛŒÙ„ sidebarStore.ts Ø±Ùˆ Ù†Ø¯Ø§Ø¯ÛŒ!
Ø¨Ø°Ø§Ø± Ø¨Ø¨ÛŒÙ†Ù… Ú†ÛŒ Ø¯Ø§Ø±ÛŒ:ØªØ­Ù„ÛŒÙ„ Sidebar Store Ùˆ Ù…Ø´Ú©Ù„Ø§ØªDocumentÂ # ğŸ” ØªØ­Ù„ÛŒÙ„ Sidebar Store

## Ù…Ø´Ú©Ù„ ÙØ¹Ù„ÛŒ

ØªÙˆ Ø§Ø² Ø§ÛŒÙ† import Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒ:
```typescript
import {useAdminStore} from "@/components/layout/Sidebar/stores/sidebarStore";
```

ÙˆÙ„ÛŒ Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ø±Ùˆ Ø¨Ù‡Ù… Ù†Ø¯Ø§Ø¯ÛŒ! Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ù…Ø­ØªÙˆØ§Ø´ Ú†ÛŒØ²ÛŒ Ø´Ø¨ÛŒÙ‡ Ø§ÛŒÙ†Ù‡:

```typescript
// coØ­Ø§Ù„Ø§ Ø¨Ø°Ø§Ø± ÛŒÚ© Ø±Ø§Ù‡ Ø­Ù„ Ø¬Ø§Ù…Ø¹ Ø¨Ø±Ø§Øª Ø¨Ù†ÙˆÛŒØ³Ù… Ú©Ù‡ Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø±Ùˆ cover Ú©Ù†Ù‡:Ù¾Ù„Ø§Ù† Ú©Ø§Ù…Ù„ Fix Ú©Ø±Ø¯Ù† StorageCodeÂ // ============================================
// STEP 1: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Cleanup Hook
// ============================================

// hooks/useStorageCleanup.ts (ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯)
import { useEffect } from 'react';

export function useStorageCleanup() {
  Ø­Ø§Ù„Ø§ Ø¨Ø°Ø§Ø± ÛŒÚ© Ú†Ú©â€ŒÙ„ÛŒØ³Øª Ø¹Ù…Ù„ÛŒ Ø¨Ø±Ø§Øª Ø¨Ù†ÙˆÛŒØ³Ù…:Ú†Ú©â€ŒÙ„ÛŒØ³Øª Ø§Ù‚Ø¯Ø§Ù…Ø§Øª ÙÙˆØ±ÛŒDocumentÂ # âœ… Ú†Ú©â€ŒÙ„ÛŒØ³Øª Ø§Ù‚Ø¯Ø§Ù…Ø§Øª ÙÙˆØ±ÛŒ

## ğŸ”´ Priority 1: Ø§Ù…Ø±ÙˆØ² (Critical Security Fix)

### 1. Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† StorageCleanupProvider

```bash
# ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯ Ø¨Ø³Ø§Ø²:
touch components/providers/StorageCleanupProvider.tsx
```

Ù…Ø­ØªÙˆØ§ Ø§Ø² artifact #10 Ú©Ù¾ÛŒ Ú©Ù†.

### 2. Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ğŸ“ Ø®Ù„Ø§ØµÙ‡ Ø¨Ø±Ø§ÛŒ ØªÙˆ
ğŸ¯ ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ:
âœ… Ú†ÛŒØ²Ù‡Ø§ÛŒ Ø®ÙˆØ¨:

Sidebar state Ø¨Ø§ Zustand (Ø¯Ø±Ø³Øª - UI state sensitive Ù†ÛŒØ³Øª)
Layout structure ØªÙ…ÛŒØ² Ùˆ modular
Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² TypeScript

âŒ Ú†ÛŒØ²Ù‡Ø§ÛŒ Ø¨Ø¯:

admin_csrf_token Ø¯Ø± localStorage (Ø®Ø·Ø±Ù†Ø§Ú©!)
Ø¯Ø± sessionToken.ts Ù‡Ù… localStorage Ùˆ Ù‡Ù… sessionStorage Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡

ğŸš€ Ú©Ø§Ø± ÙÙˆØ±ÛŒ (20 Ø¯Ù‚ÛŒÙ‚Ù‡):

Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†: StorageCleanupProvider.tsx (artifact #10)
Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ù†: app/layout.tsx (Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† provider)
Fix Ú©Ù†: sessionToken.ts (Ú©Ø§Ù…Ù†Øª Ú©Ø±Ø¯Ù† localStorage lines)
ØªØ³Øª Ú©Ù†: Browser console Ùˆ storage

ğŸ“ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ù†ÛŒØ§Ø² Ø¯Ø§Ø±Ù…:

components/layout/Sidebar/stores/sidebarStore.ts
Django settings.py (ÙÙ‚Ø· CSRF/CORS sections)
Ø¢ÛŒØ§ Ø§Ø² next-themes Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒ Ø¨Ø±Ø§ÛŒ themeØŸ

Ø§ÛŒÙ† Ø±Ùˆ Ø¨Ù‡Ù… Ø¨Ø¯Ù‡ ØªØ§ Ø¨Ù‚ÛŒÙ‡ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒâ€ŒÙ‡Ø§ Ø±Ùˆ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù…! ğŸ’ªRetry

// core/auth/csrfToken.ts
/**
 * CSRF Token Management
 * 
 * Django sends CSRF token in two ways:
 * 1. Cookie: csrftoken (HttpOnly=False for JS access)
 * 2. Response header: X-CSRFToken (fallback)
 * 
 * Security Notes:
 * - Never store CSRF in localStorage (XSS vulnerable)
 * - Use sessionStorage only (cleared on tab close)
 * - Always validate token existence before API calls
 */

interface CSRFTokenStore {
  token: string | null;
  lastUpdated: number | null;
  isValid: () => boolean;
}

class CSRFTokenManager {
  private static instance: CSRFTokenManager;
  private store: CSRFTokenStore = {
    token: null,
    lastUpdated: null,
    isValid: function() {
      if (!this.token || !this.lastUpdated) return false;
      // Token expires after 1 hour
      const now = Date.now();
      return (now - this.lastUpdated) < 3600000;
    }
  };

  private readonly CSRF_COOKIE_NAME = 'csrftoken';
  private readonly SESSION_STORAGE_KEY = '__csrf_token__';
  private readonly TOKEN_MAX_AGE = 3600000; // 1 hour

  private constructor() {
    // Initialize from sessionStorage on create
    this.loadFromStorage();
  }

  public static getInstance(): CSRFTokenManager {
    if (!CSRFTokenManager.instance) {
      CSRFTokenManager.instance = new CSRFTokenManager();
    }
    return CSRFTokenManager.instance;
  }

  /**
   * Get CSRF token from cookie
   * Django must set csrftoken cookie with HttpOnly=False
   */
  private getCookieToken(): string | null {
    if (typeof document === 'undefined') return null;

    try {
      const cookies = document.cookie.split(';');
      for (const cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === this.CSRF_COOKIE_NAME) {
          return decodeURIComponent(value);
        }
      }
    } catch (error) {
      console.error('[CSRF] Cookie read error:', error);
    }
    return null;
  }

  /**
   * Load token from sessionStorage (fast)
   */
  private loadFromStorage(): void {
    if (typeof window === 'undefined') return;

    try {
      const stored = sessionStorage.getItem(this.SESSION_STORAGE_KEY);
      if (stored) {
        const parsed = JSON.parse(stored);
        if (parsed.token && parsed.lastUpdated) {
          this.store.token = parsed.token;
          this.store.lastUpdated = parsed.lastUpdated;
          
          // Validate age
          if (!this.store.isValid()) {
            this.clear();
          }
        }
      }
    } catch (error) {
      console.error('[CSRF] Storage load error:', error);
      this.clear();
    }
  }

  /**
   * Save token to sessionStorage
   */
  private saveToStorage(): void {
    if (typeof window === 'undefined') return;

    try {
      if (this.store.token) {
        sessionStorage.setItem(
          this.SESSION_STORAGE_KEY,
          JSON.stringify({
            token: this.store.token,
            lastUpdated: this.store.lastUpdated
          })
        );
      } else {
        sessionStorage.removeItem(this.SESSION_STORAGE_KEY);
      }
    } catch (error) {
      console.error('[CSRF] Storage save error:', error);
    }
  }

  /**
   * Get valid CSRF token
   * Priority: memory > sessionStorage > cookie
   */
  public getToken(): string | null {
    // 1. Check memory (fastest)
    if (this.store.isValid()) {
      return this.store.token;
    }

    // 2. Check sessionStorage
    this.loadFromStorage();
    if (this.store.isValid()) {
      return this.store.token;
    }

    // 3. Check cookie (slowest)
    const cookieToken = this.getCookieToken();
    if (cookieToken) {
      this.setToken(cookieToken);
      return cookieToken;
    }

    return null;
  }

  /**
   * Set CSRF token
   */
  public setToken(token: string | null): void {
    if (token) {
      this.store.token = token;
      this.store.lastUpdated = Date.now();
      this.saveToStorage();
    } else {
      this.clear();
    }
  }

  /**
   * Clear CSRF token
   */
  public clear(): void {
    this.store.token = null;
    this.store.lastUpdated = null;
    if (typeof window !== 'undefined') {
      sessionStorage.removeItem(this.SESSION_STORAGE_KEY);
    }
  }

  /**
   * Refresh token from cookie
   */
  public async refresh(): Promise<string | null> {
    const cookieToken = this.getCookieToken();
    if (cookieToken) {
      this.setToken(cookieToken);
      return cookieToken;
    }
    
    // If no cookie, token might be in response header
    // This is handled by fetch interceptor
    return null;
  }

  /**
   * Check if token exists and is valid
   */
  public hasValidToken(): boolean {
    const token = this.getToken();
    return token !== null && token.length > 0;
  }
}

// Export singleton instance
export const csrfManager = CSRFTokenManager.getInstance();

// Legacy compatibility (for gradual migration)
export const csrfTokenStore = {
  getToken: () => csrfManager.getToken(),
  setToken: (token: string | null) => csrfManager.setToken(token),
  clearToken: () => csrfManager.clear(),
  hasToken: () => csrfManager.hasValidToken(),
  refreshToken: () => csrfManager.refresh(),
  getStoredToken: () => csrfManager.getToken(),
};


// middleware.ts
import { NextRequest, NextResponse } from "next/server";

const SESSION_COOKIE_NAME = 'sessionid';
const CSRF_COOKIE_NAME = 'csrftoken';

// Public paths that don't require authentication
const PUBLIC_PATHS = ['/login'];
const PUBLIC_PREFIXES = ['/_next', '/api', '/favicon.ico', '/images', '/assets'];

// Rate limiting (simple in-memory, production needs Redis)
const rateLimitMap = new Map<string, { count: number; resetAt: number }>();
const RATE_LIMIT = 100; // requests per minute
const RATE_WINDOW = 60000; // 1 minute

function checkRateLimit(ip: string): boolean {
  const now = Date.now();
  const record = rateLimitMap.get(ip);

  if (!record || now > record.resetAt) {
    rateLimitMap.set(ip, { count: 1, resetAt: now + RATE_WINDOW });
    return true;
  }

  if (record.count >= RATE_LIMIT) {
    return false;
  }

  record.count++;
  return true;
}

export async function middleware(req: NextRequest) {
  const { pathname, search } = req.nextUrl;

  // ============================================
  // 1. Skip middleware for static assets & API
  // ============================================
  if (PUBLIC_PREFIXES.some(prefix => pathname.startsWith(prefix))) {
    return NextResponse.next();
  }

  // ============================================
  // 2. Rate limiting (basic)
  // ============================================
  const ip = req.ip || req.headers.get('x-forwarded-for') || 'unknown';
  if (!checkRateLimit(ip)) {
    return new NextResponse('Too Many Requests', { status: 429 });
  }

  // ============================================
  // 3. Check authentication
  // ============================================
  const sessionCookie = req.cookies.get(SESSION_COOKIE_NAME);
  const csrfCookie = req.cookies.get(CSRF_COOKIE_NAME);
  const isAuthenticated = !!sessionCookie?.value;
  const isPublicPath = PUBLIC_PATHS.includes(pathname);

  // ============================================
  // 4. Authentication flow
  // ============================================
  
  // Redirect to login if not authenticated
  if (!isAuthenticated && !isPublicPath) {
    const loginUrl = new URL('/login', req.url);
    
    // Preserve return URL (except for root)
    if (pathname !== '/') {
      loginUrl.searchParams.set('return_to', pathname + search);
    }
    
    return NextResponse.redirect(loginUrl);
  }

  // Redirect to dashboard if authenticated and trying to access login
  if (isAuthenticated && isPublicPath) {
    return NextResponse.redirect(new URL('/', req.url));
  }

  // ============================================
  // 5. Security headers for authenticated routes
  // ============================================
  if (isAuthenticated) {
    const response = NextResponse.next();
    
    // Add security headers
    response.headers.set('X-Frame-Options', 'DENY');
    response.headers.set('X-Content-Type-Options', 'nosniff');
    response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');
    response.headers.set('Permissions-Policy', 'camera=(), microphone=(), geolocation=()');
    
    // CSRF token validation for non-GET requests
    // This is just a header check, actual validation is in Django
    const method = req.method;
    if (method !== 'GET' && method !== 'HEAD' && method !== 'OPTIONS') {
      const csrfHeader = req.headers.get('X-CSRFToken');
      if (!csrfHeader && !csrfCookie?.value) {
        console.warn('[Middleware] Missing CSRF token for', method, pathname);
      }
    }
    
    return response;
  }

  return NextResponse.next();
}

export const config = {
  matcher: [
    /*
     * Match all request paths except:
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     * - public folder files
     */
    '/((?!_next/static|_next/image|favicon.ico|images|assets).*)',
  ]
};


'use client';

import React, { createContext, useContext, useEffect, useState, useCallback } from 'react';
import { useRouter, usePathname } from 'next/navigation';
import { UserWithProfile } from '@/types/auth/user';
import { authApi } from '@/api/auth/route';
import { ApiError } from '@/types/api/apiError';
import { csrfManager } from '@/core/auth/csrfToken';
import { PanelSettings } from '@/types/settings/panelSettings';
import { getPanelSettings } from '@/api/settings/panel/route';

interface AuthContextType {
  user: UserWithProfile | null;
  panelSettings: PanelSettings | null;
  isLoading: boolean;
  isAuthenticated: boolean;
  login: (mobile: string, password?: string, captchaId?: string, captchaAnswer?: string) => Promise<void>;
  loginWithOTP: (mobile: string, otp: string, captchaId?: string, captchaAnswer?: string) => Promise<void>;
  logout: () => Promise<void>;
  refreshUser: () => Promise<void>;
  updatePanelSettingsInContext: (settings: PanelSettings) => void;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

const PUBLIC_PATHS = ['/login'];

// Serialize helpers for Next.js 15 compatibility
function serializeUser(user: any): UserWithProfile | null {
  if (!user) return null;
  return {
    ...user,
    user_type: user.user_type || 'admin',
    permissions: Array.isArray(user.permissions) ? [...user.permissions] : [],
    permission_categories: user.permission_categories || {},
    profile: user.profile || undefined,
    roles: user.roles || [],
  };
}

function serializePanelSettings(settings: PanelSettings | null): PanelSettings | null {
  if (!settings) return null;
  return { ...settings };
}

export const AuthProvider = ({ children }: { children: React.ReactNode }) => {
  const [user, setUser] = useState<UserWithProfile | null>(null);
  const [panelSettings, setPanelSettings] = useState<PanelSettings | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const router = useRouter();
  const pathname = usePathname();

  // ============================================
  // Load panel settings (background)
  // ============================================
  const loadPanelSettings = useCallback(async () => {
    try {
      const settings = await getPanelSettings();
      if (settings) {
        setPanelSettings(serializePanelSettings(settings));
      }
    } catch (error) {
      console.warn('[Auth] Panel settings load failed:', error);
    }
  }, []);

  // ============================================
  // Check user authentication status
  // ============================================
  const checkUserStatus = useCallback(async () => {
    setIsLoading(true);

    try {
      // Get user data (critical)
      const userData = await authApi.getCurrentAdminUser({ cache: 'no-store' });
      
      if (userData) {
        setUser(serializeUser(userData));
        
        // Refresh CSRF token
        await csrfManager.refresh();
        
        // Load settings in background
        loadPanelSettings().catch(err => 
          console.warn('[Auth] Background settings load failed:', err)
        );
      } else {
        // No user data
        handleUnauthenticated();
      }
    } catch (error) {
      if (error instanceof ApiError && error.response.AppStatusCode === 401) {
        handleUnauthenticated();
      } else {
        console.error('[Auth] Check user status error:', error);
        setUser(null);
        setPanelSettings(null);
      }
    } finally {
      setIsLoading(false);
    }
  }, [pathname, router, loadPanelSettings]);

  // ============================================
  // Handle unauthenticated state
  // ============================================
  const handleUnauthenticated = useCallback(() => {
    setUser(null);
    setPanelSettings(null);
    csrfManager.clear();
    clearAuthCookies();

    // Redirect to login if on protected route
    if (!PUBLIC_PATHS.includes(pathname)) {
      const currentPath = window.location.pathname + window.location.search;
      const returnToParam = currentPath !== '/' 
        ? `?return_to=${encodeURIComponent(currentPath)}` 
        : '';
      router.push(`/login${returnToParam}`);
    }
  }, [pathname, router]);

  // ============================================
  // Clear auth cookies
  // ============================================
  const clearAuthCookies = () => {
    if (typeof window === 'undefined') return;

    const cookiesToClear = [
      'sessionid',
      'csrftoken',
      'admin_session',
    ];

    cookiesToClear.forEach(name => {
      document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
      document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=${window.location.hostname};`;
    });
  };

  // ============================================
  // Initial check on mount
  // ============================================
  useEffect(() => {
    checkUserStatus();
  }, [checkUserStatus]);

  // ============================================
  // Login with password
  // ============================================
  const login = async (
    mobile: string, 
    password?: string, 
    captchaId?: string, 
    captchaAnswer?: string
  ) => {
    setIsLoading(true);

    try {
      // 1. Login and get session
      const loginData = {
        mobile,
        login_type: 'password' as const,
        password: password || '',
        captcha_id: captchaId || '',
        captcha_answer: captchaAnswer || '',
      };
      
      await authApi.login(loginData);

      // 2. Refresh CSRF token
      await csrfManager.refresh();

      // 3. Get user data (CRITICAL - must complete before navigation)
      const userData = await authApi.getCurrentAdminUser({ cache: 'no-store' });
      
      if (!userData) {
        throw new Error('Failed to load user data after login');
      }

      setUser(serializeUser(userData));

      // 4. Load settings in background (non-blocking)
      loadPanelSettings().catch(err => 
        console.warn('[Auth] Background settings load failed:', err)
      );

      // 5. Navigate (AFTER user data is loaded)
      const urlParams = new URLSearchParams(window.location.search);
      const returnTo = urlParams.get('return_to') || '/';
      router.push(returnTo);

    } catch (error) {
      setUser(null);
      setPanelSettings(null);
      throw error; // Re-throw for LoginForm to handle
    } finally {
      setIsLoading(false);
    }
  };

  // ============================================
  // Login with OTP
  // ============================================
  const loginWithOTP = async (
    mobile: string, 
    otp: string, 
    captchaId?: string, 
    captchaAnswer?: string
  ) => {
    setIsLoading(true);

    try {
      const loginData = {
        mobile,
        login_type: 'otp' as const,
        otp_code: otp,
        captcha_id: captchaId || '',
        captcha_answer: captchaAnswer || '',
      };

      await authApi.login(loginData);
      await csrfManager.refresh();

      const userData = await authApi.getCurrentAdminUser({ cache: 'no-store' });
      
      if (!userData) {
        throw new Error('Failed to load user data after login');
      }

      setUser(serializeUser(userData));

      loadPanelSettings().catch(err => 
        console.warn('[Auth] Background settings load failed:', err)
      );

      const urlParams = new URLSearchParams(window.location.search);
      const returnTo = urlParams.get('return_to') || '/';
      router.push(returnTo);

    } catch (error) {
      setUser(null);
      setPanelSettings(null);
      throw error;
    } finally {
      setIsLoading(false);
    }
  };

  // ============================================
  // Logout
  // ============================================
  const logout = async () => {
    setIsLoading(true);

    try {
      await authApi.logout();
    } catch (error) {
      console.error('[Auth] Logout API error:', error);
    } finally {
      // Always clear frontend state
      clearAuthCookies();
      setUser(null);
      setPanelSettings(null);
      csrfManager.clear();

      if (typeof window !== 'undefined') {
        sessionStorage.clear();
        localStorage.clear();
      }

      setIsLoading(false);
      
      // Hard redirect to clear all state
      window.location.href = '/login';
    }
  };

  // ============================================
  // Refresh user data
  // ============================================
  const refreshUser = async () => {
    try {
      const userData = await authApi.getCurrentAdminUser({ cache: 'no-store' });
      
      if (userData) {
        setUser(serializeUser(userData));
        await csrfManager.refresh();
        loadPanelSettings().catch(err => 
          console.warn('[Auth] Background settings load failed:', err)
        );
      } else {
        handleUnauthenticated();
      }
    } catch (error) {
      if (!(error instanceof ApiError && error.response.AppStatusCode === 401)) {
        console.error('[Auth] Refresh user error:', error);
      }
      handleUnauthenticated();
    }
  };

  // ============================================
  // Update panel settings
  // ============================================
  const updatePanelSettingsInContext = (newSettings: PanelSettings) => {
    const timestamp = Date.now();
    const processed = serializePanelSettings(newSettings);
    
    if (processed) {
      // Add cache busting to image URLs
      if (processed.logo_url) {
        const baseUrl = processed.logo_url.split('?')[0];
        processed.logo_url = `${baseUrl}?t=${timestamp}`;
      }
      if (processed.favicon_url) {
        const baseUrl = processed.favicon_url.split('?')[0];
        processed.favicon_url = `${baseUrl}?t=${timestamp}`;
      }
    }
    
    setPanelSettings(processed);
  };

  const value = {
    user,
    panelSettings,
    isLoading,
    isAuthenticated: !!user && !isLoading,
    login,
    loginWithOTP,
    logout,
    refreshUser,
    updatePanelSettingsInContext,
  };

  return (
    <AuthContext.Provider value={value}>
      {children}
    </AuthContext.Provider>
  );
};

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within AuthProvider');
  }
  return context;
};


ğŸ“‹ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ Ú©Ù‡ Ù…Ù…Ú©Ù†Ù‡ Ù†Ø¯Ø§Ø¯ÛŒ
ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ú©ÙˆÚ©ÛŒâ€ŒÙ‡Ø§ Ùˆ Storage Usage
Ú©ÙˆÚ©ÛŒâ€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ:
1. âœ“ sessionid (cookie)
2. âœ“ csrftoken (cookie)  
3. âŒ admin_csrf_token (localStorage) - Ø§ÛŒÙ† Ø§Ø² Ú©Ø¬Ø§ Ù…ÛŒØ§Ø¯ØŸ
4. âŒ admin-ui-storage (localStorage) - Ø§ÛŒÙ† Ø§Ø² Ú©Ø¬Ø§ Ù…ÛŒØ§Ø¯ØŸ
5. âŒ email_draft (localStorage) - ÙÛŒÚ†Ø± Email Ø¯Ø§Ø±ÛŒØŸ
6. âŒ theme (localStorage) - ThemeProvider Ø¯Ø§Ø±ÛŒØŸ

ğŸ“ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ
1. Theme Provider (Ù…Ø·Ù…Ø¦Ù†Ù… Ø¯Ø§Ø±ÛŒ ÙˆÙ„ÛŒ Ù†Ø¯Ø§Ø¯ÛŒ)
typescript// components/providers/ThemeProvider.tsx ÛŒØ§ theme context
// Ø§ÛŒÙ† ÙØ§ÛŒÙ„ theme Ø±Ùˆ Ø¯Ø± localStorage Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ù‡
Ú†Ø±Ø§ Ù…Ù‡Ù…Ù‡ØŸ

Ø¨Ø§ÛŒØ¯ Ø¨Ø¯ÙˆÙ†Ù… Ú†Ø·ÙˆØ± theme Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒØ´Ù‡
Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ localStorage usage

2. UI State Management (sidebar state)
typescript// admin-ui-storage Ø§Ø² Ú©Ø¬Ø§ Ù…ÛŒØ§Ø¯ØŸ
// Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ ÛŒÚ© ÙØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ sidebar state Ø¯Ø§Ø±ÛŒ
Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹:

components/layout/Sidebar.tsx
contexts/UIContext.tsx
ÛŒØ§ state management Ø¯ÛŒÚ¯Ù‡

3. Email Feature (email_draft)
typescript// ÛŒÚ© ÙÛŒÚ†Ø± email Ø¯Ø§Ø±ÛŒ Ú©Ù‡ draft Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ù‡ØŸ
// Ø§ÛŒÙ† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ùˆ Ù†Ú¯Ø±ÙØªÙ…:
Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹:

features/email/ ÛŒØ§ components/email/
Email composer component

4. sessionToken.ts Usage Points
Ø¨Ø°Ø§Ø± Ø¨Ø¨ÛŒÙ†Ù… sessionToken.ts Ú©Ø¬Ø§Ù‡Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡:
typescript// ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ sessionToken Ø±Ùˆ import Ù…ÛŒâ€ŒÚ©Ù†Ù†:
// 1. fetch.ts âœ“ (Ø¯Ø§Ø¯ÛŒ)
// 2. AuthContext.tsx âœ“ (Ø¯Ø§Ø¯ÛŒ)
// 3. ??? (Ù†Ú¯Ø±ÙØªÙ…)

ğŸ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù… Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Ø¨Ø¯ÛŒ
Priority 1: Critical

ThemeProvider.tsx ÛŒØ§ ThemeContext

typescript// components/providers/ThemeProvider.tsx
// ÛŒØ§ Ù‡Ø± ÙØ§ÛŒÙ„ÛŒ Ú©Ù‡ theme Ø±Ùˆ manage Ù…ÛŒâ€ŒÚ©Ù†Ù‡

localStorage/sessionStorage usage Ø¯Ø± Ú©Ù„ Ù¾Ø±ÙˆÚ˜Ù‡

bash# ØªÙˆ terminal Ø§ÛŒÙ† command Ø±Ùˆ Ø¨Ø²Ù†:
grep -r "localStorage" src/
grep -r "sessionStorage" src/

Django Backend Settings

python# Backend/config/django/base.py ÛŒØ§ settings.py
# Ø¨Ø®Ø´ CSRF Ùˆ Session settings
Priority 2: Ù…Ù‡Ù…

Layout Component

typescript// app/layout.tsx Ø±Ùˆ Ø¯Ø§Ø¯ÛŒ âœ“
// ÙˆÙ„ÛŒ main dashboard layout Ø±Ùˆ Ù†Ø¯Ø§Ø¯ÛŒ
// Ù…Ø«Ù„Ø§Ù‹ app/(dashboard)/layout.tsx

Sidebar/Navigation Component

typescript// components/layout/Sidebar.tsx
// Ú©Ù‡ admin-ui-storage Ø±Ùˆ Ù…ÛŒâ€ŒØ³Ø§Ø²Ù‡

Query Client Configuration

typescript// components/providers/QueryProvider.tsx
// Ø±Ùˆ Ù†Ø¯Ø§Ø¯ÛŒ (ÙÙ‚Ø· Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² getQueryClient Ø¯ÛŒØ¯Ù…)

ğŸ”§ Ú†Ú© Ú©Ù† Ø§ÛŒÙ† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ùˆ Ø¯Ø§Ø±ÛŒØŸ
Ø¯Ø± Ù¾ÙˆØ´Ù‡ src/ ÛŒØ§ app/:
src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ providers/
â”‚   â”‚   â”œâ”€â”€ ThemeProvider.tsx (Ù†Ú¯Ø±ÙØªÙ… âŒ)
â”‚   â”‚   â””â”€â”€ QueryProvider.tsx (Ù†Ú¯Ø±ÙØªÙ… âŒ)
â”‚   â”œâ”€â”€ layout/
â”‚   â”‚   â”œâ”€â”€ Sidebar.tsx (Ù†Ú¯Ø±ÙØªÙ… âŒ)
â”‚   â”‚   â”œâ”€â”€ Header.tsx (Ù†Ú¯Ø±ÙØªÙ… âŒ)
â”‚   â”‚   â””â”€â”€ DashboardLayout.tsx (Ù†Ú¯Ø±ÙØªÙ… âŒ)
â”‚   â””â”€â”€ features/
â”‚       â””â”€â”€ email/ (Ù†Ú¯Ø±ÙØªÙ… âŒ)
â”œâ”€â”€ app/
â”‚   â””â”€â”€ (dashboard)/
â”‚       â””â”€â”€ layout.tsx (Ù†Ú¯Ø±ÙØªÙ… âŒ)
â””â”€â”€ lib/ ÛŒØ§ utils/
    â””â”€â”€ storage.ts (Ù†Ú¯Ø±ÙØªÙ… âŒ)

ğŸš¨ Ù…Ø´Ú©Ù„ Ø§ØµÙ„ÛŒ: localStorage Ø¯Ø± Ù‡Ù…Ù‡ Ø¬Ø§!
Ø§Ø² Ø±ÙˆÛŒ Ú©ÙˆÚ©ÛŒâ€ŒÙ‡Ø§Øª Ù…Ø´Ø®ØµÙ‡ Ú©Ù‡:

CSRF token Ù‡Ù… Ø¯Ø± cookie Ù‡Ù… Ø¯Ø± localStorage Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒØ´Ù‡
UI state (sidebar) Ø¯Ø± localStorage
Email drafts Ø¯Ø± localStorage
Theme Ø¯Ø± localStorage

Ø§ÛŒÙ† ÛŒØ¹Ù†ÛŒ Ø­Ø¯Ø§Ù‚Ù„ 4 Ù†Ù‚Ø·Ù‡ vulnerability Ø¯Ø§Ø±ÛŒ!

âœ… Ú©Ø§Ø±ÛŒ Ú©Ù‡ Ø¨Ø§ÛŒØ¯ ÙÙˆØ±ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯ÛŒ
1. Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… localStorage usage
bash# Ø¯Ø± terminal Ù¾Ø±ÙˆÚ˜Ù‡:
grep -rn "localStorage.setItem" src/
grep -rn "localStorage.getItem" src/
2. ÙØ±Ø³ØªØ§Ø¯Ù† Ø§ÛŒÙ† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§:

 QueryProvider.tsx
 ThemeProvider.tsx
 Sidebar.tsx ÛŒØ§ UIContext
 Ù‡Ø± ÙØ§ÛŒÙ„ÛŒ Ú©Ù‡ localStorage Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ù‡
 Django settings.py (Ø¨Ø®Ø´ CSRF Ùˆ CORS)

3. Ø¨Ø±Ø±Ø³ÛŒ Next.js config
typescript// next.config.js ÛŒØ§ next.config.mjs
// Ø¢ÛŒØ§ httpOnly cookies ÙØ¹Ø§Ù„Ù‡ØŸ

ğŸ’¡ Ø±Ø§Ù‡ Ø­Ù„ Ù…ÙˆÙ‚Øª (ØªØ§ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ùˆ Ø¨Ø¯ÛŒ)
Ø¨Ø±Ø§ÛŒ Ø§Ù„Ø§Ù† Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§ÛŒÙ† Ú©Ø¯ Ø±Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒ ØªØ§ localStorage Ø§ÛŒÙ…Ù†â€ŒØªØ± Ø¨Ø´Ù‡:
typescript// lib/storage.ts (ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯)

type StorageType = 'session' | 'local';

class SecureStorage {
  private getStorage(type: StorageType): Storage | null {
    if (typeof window === 'undefined') return null;
    return type === 'session' ? sessionStorage : localStorage;
  }

  // ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ non-sensitive data
  setItem(key: string, value: any, type: StorageType = 'session') {
    const storage = this.getStorage(type);
    if (!storage) return;
    
    // âš ï¸ Ù‡Ø±Ú¯Ø² CSRF token ÛŒØ§ sensitive data Ø°Ø®ÛŒØ±Ù‡ Ù†Ú©Ù†
    if (key.includes('token') || key.includes('password')) {
      console.error('âŒ Security Error: Cannot store sensitive data');
      return;
    }
    
    storage.setItem(key, JSON.stringify(value));
  }

  getItem(key: string, type: StorageType = 'session'): any {
    const storage = this.getStorage(type);
    if (!storage) return null;
    
    const item = storage.getItem(key);
    return item ? JSON.parse(item) : null;
  }
}

export const storage = new SecureStorage();

ğŸ“ Ú†Ú©â€ŒÙ„ÛŒØ³Øª
Ø¨Ø±Ø§ÛŒ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ØŒ Ø§ÛŒÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ùˆ Ø¨Ù‡Ù… Ø¨Ø¯Ù‡:

 ThemeProvider.tsx
 QueryProvider.tsx
 Sidebar.tsx ÛŒØ§ UIContext
 ØªÙ…Ø§Ù… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ localStorage Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ù† (output grep -r "localStorage")
 Django settings.py (ÙÙ‚Ø· Ø¨Ø®Ø´ CSRF, CORS, SESSION)
 next.config.js/mjs
 app/(dashboard)/layout.tsx (Ø§Ú¯Ù‡ Ø¯Ø§Ø±ÛŒ)
 Ù‡Ø± storage utility Ú©Ù‡ Ù†ÙˆØ´ØªÛŒ

Ø¨Ø¹Ø¯ Ø§Ø² Ø¯Ø±ÛŒØ§ÙØª Ø§ÛŒÙ† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ØŒ ÛŒÚ© Ø±Ø§Ù‡ Ø­Ù„ Ø¬Ø§Ù…Ø¹ Ùˆ Ø§Ù…Ù† Ø¨Ø±Ø§Øª Ù…ÛŒâ€ŒÙ†ÙˆÛŒØ³Ù…! ğŸ¯