---
description: categories
alwaysApply: true
---

# ğŸ“‹ Ø¯Ø§Ú©ÛŒÙˆÙ…Ù†Øª Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ: Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ ØªÙˆØ¯Ø±ØªÙˆ
**Django 5.2.6 + PostgreSQL + Next.js Admin Panel**

---

## ğŸ¯ Ø§Ù†ØªØ®Ø§Ø¨ Ø±Ø§Ù‡Ú©Ø§Ø±

**django-treebeard** Ø¨Ø§ Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… **Materialized Path**

**Ù…Ø²Ø§ÛŒØ§:**
- Ø³Ø±Ø¹Øª Ø¨Ø§Ù„Ø§ Ø¨Ø±Ø§ÛŒ read/write operations
- API Ø³Ø§Ø¯Ù‡ Ùˆ Ù‚Ø¯Ø±ØªÙ…Ù†Ø¯
- Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ú©Ø§Ù…Ù„ Ø¨Ø§ Django 5.2+
- Ø¨Ù‡ÛŒÙ†Ù‡ Ø¨Ø±Ø§ÛŒ PostgreSQL

---

## ğŸ”§ Ù†ØµØ¨ Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª

```bash
# Ù†ØµØ¨ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡
pip install django-treebeard==4.7

# requirements.txt
django-treebeard==4.7
```

```python
# settings.py
INSTALLED_APPS = [
    # Django apps
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    # Third party
    'rest_framework',
    'treebeard',
    # Local apps
    'categories',
]
```

---

## ğŸ“Š Ù…Ø¯Ù„ Category

```python
# categories/models.py
from django.db import models
from django.utils.text import slugify
from treebeard.mp_tree import MP_Node

class Category(MP_Node):
    name = models.CharField(max_length=255, verbose_name="Ù†Ø§Ù… Ø¯Ø³ØªÙ‡")
    slug = models.SlugField(max_length=255, unique=True, verbose_name="Ù†Ø§Ù…Ú©")
    description = models.TextField(blank=True, verbose_name="ØªÙˆØ¶ÛŒØ­Ø§Øª")
    image = models.ImageField(
        upload_to='categories/%Y/%m/', 
        blank=True, 
        null=True,
        verbose_name="ØªØµÙˆÛŒØ±"
    )
    is_active = models.BooleanField(default=True, verbose_name="ÙˆØ¶Ø¹ÛŒØª")
    sort_order = models.PositiveIntegerField(default=0, verbose_name="ØªØ±ØªÛŒØ¨")
    
    # SEO fields
    meta_title = models.CharField(max_length=60, blank=True)
    meta_description = models.CharField(max_length=160, blank=True)
    
    # Timestamps
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    # Tree settings
    node_order_by = ['sort_order', 'name']
    
    class Meta:
        db_table = 'categories'
        verbose_name = "Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ"
        verbose_name_plural = "Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§"
        indexes = [
            # Core indexes Ø¨Ø±Ø§ÛŒ performance
            models.Index(fields=['path']),
            models.Index(fields=['is_active', 'path']),
            models.Index(fields=['slug']),
            models.Index(fields=['sort_order']),
        ]
        constraints = [
            models.CheckConstraint(
                check=models.Q(sort_order__gte=0),
                name='positive_sort_order'
            )
        ]
    
    def __str__(self):
        return self.name
    
    def save(self, *args, **kwargs):
        if not self.slug:
            self.slug = slugify(self.name)
        super().save(*args, **kwargs)
    
    @property
    def breadcrumbs(self):
        """Ù…Ø³ÛŒØ± Ú©Ø§Ù…Ù„ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ"""
        return [ancestor.name for ancestor in self.get_ancestors()] + [self.name]
    
    @property
    def full_path(self):
        """Ù…Ø³ÛŒØ± Ú©Ø§Ù…Ù„ Ø¨Ø±Ø§ÛŒ URL"""
        return "/".join(ancestor.slug for ancestor in self.get_ancestors()) + f"/{self.slug}"
    
    def get_absolute_url(self):
        return f"/categories/{self.full_path}/"
```

---

## ğŸ” Manager Ùˆ QuerySet

```python
# categories/managers.py
from django.db import models
from django.core.cache import cache
from treebeard.mp_tree import MP_NodeQuerySet

class CategoryQuerySet(MP_NodeQuerySet):
    def active(self):
        return self.filter(is_active=True)
    
    def with_product_count(self):
        """ØªØ¹Ø¯Ø§Ø¯ Ù…Ø­ØµÙˆÙ„Ø§Øª Ù‡Ø± Ø¯Ø³ØªÙ‡"""
        return self.annotate(
            product_count=models.Count('products', distinct=True)
        )
    
    def main_categories(self):
        """Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ ÙÙ‚Ø·"""
        return self.filter(depth=1).active().order_by('sort_order', 'name')

class CategoryManager(models.Manager):
    def get_queryset(self):
        return CategoryQuerySet(self.model, using=self._db)
    
    def active(self):
        return self.get_queryset().active()
    
    def roots(self):
        return self.get_queryset().main_categories()
    
    def get_tree_data(self):
        """Ø¯Ø±Ø®Øª Ú©Ø§Ù…Ù„ Ø¨Ø±Ø§ÛŒ API"""
        cache_key = 'category_tree_data'
        data = cache.get(cache_key)
        
        if data is None:
            data = list(self.active().order_by('path').values(
                'id', 'name', 'slug', 'path', 'depth', 'image'
            ))
            cache.set(cache_key, data, 3600)  # 1 hour cache
        return data
    
    def clear_cache(self):
        """Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø´"""
        cache.delete('category_tree_data')
        cache.delete('category_roots')

# Ø¯Ø± models.py Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯:
# objects = CategoryManager()
```

---

## ğŸ”„ Serializers

```python
# categories/serializers.py
from rest_framework import serializers
from .models import Category

class CategoryListSerializer(serializers.ModelSerializer):
    """Ø¨Ø±Ø§ÛŒ Ù„ÛŒØ³Øª Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§"""
    children_count = serializers.SerializerMethodField()
    level = serializers.SerializerMethodField()
    
    class Meta:
        model = Category
        fields = [
            'id', 'name', 'slug', 'description', 'image', 
            'is_active', 'sort_order', 'children_count', 
            'level', 'created_at'
        ]
    
    def get_children_count(self, obj):
        return obj.get_children().filter(is_active=True).count()
    
    def get_level(self, obj):
        return obj.get_depth()

class CategoryDetailSerializer(serializers.ModelSerializer):
    """Ø¨Ø±Ø§ÛŒ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ"""
    breadcrumbs = serializers.ReadOnlyField()
    full_path = serializers.ReadOnlyField()
    parent = serializers.SerializerMethodField()
    
    class Meta:
        model = Category
        fields = [
            'id', 'name', 'slug', 'description', 'image',
            'is_active', 'sort_order', 'meta_title', 'meta_description',
            'breadcrumbs', 'full_path', 'parent', 'created_at', 'updated_at'
        ]
    
    def get_parent(self, obj):
        parent = obj.get_parent()
        return {'id': parent.id, 'name': parent.name} if parent else None

class CategoryTreeSerializer(serializers.ModelSerializer):
    """Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ø®Øª Ú©Ø§Ù…Ù„"""
    children = serializers.SerializerMethodField()
    
    class Meta:
        model = Category
        fields = ['id', 'name', 'slug', 'image', 'sort_order', 'children']
    
    def get_children(self, obj):
        children = obj.get_children().filter(is_active=True).order_by('sort_order', 'name')
        return CategoryTreeSerializer(children, many=True).data

class CategoryCreateUpdateSerializer(serializers.ModelSerializer):
    """Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´"""
    class Meta:
        model = Category
        fields = [
            'name', 'slug', 'description', 'image', 'is_active',
            'sort_order', 'meta_title', 'meta_description'
        ]
    
    def validate_slug(self, value):
        if self.instance:
            # Ø¯Ø± Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´
            if Category.objects.exclude(pk=self.instance.pk).filter(slug=value).exists():
                raise serializers.ValidationError("Ø§ÛŒÙ† Ù†Ø§Ù…Ú© Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª")
        else:
            # Ø¯Ø± Ø­Ø§Ù„Øª Ø§ÛŒØ¬Ø§Ø¯
            if Category.objects.filter(slug=value).exists():
                raise serializers.ValidationError("Ø§ÛŒÙ† Ù†Ø§Ù…Ú© Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª")
        return value
```

---

## ğŸš€ ViewSet Ùˆ API

```python
# categories/views.py
from rest_framework import viewsets, status, permissions
from rest_framework.decorators import action
from rest_framework.response import Response
from django.db import transaction
from django.shortcuts import get_object_or_404
from .models import Category
from .serializers import (
    CategoryListSerializer, CategoryDetailSerializer,
    CategoryTreeSerializer, CategoryCreateUpdateSerializer
)

class CategoryViewSet(viewsets.ModelViewSet):
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        return Category.objects.active().order_by('path')
    
    def get_serializer_class(self):
        if self.action == 'list':
            return CategoryListSerializer
        elif self.action in ['create', 'update', 'partial_update']:
            return CategoryCreateUpdateSerializer
        return CategoryDetailSerializer
    
    @action(detail=False, methods=['get'], permission_classes=[permissions.AllowAny])
    def tree(self, request):
        """Ø¯Ø±Ø®Øª Ú©Ø§Ù…Ù„ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§"""
        roots = Category.objects.roots()
        serializer = CategoryTreeSerializer(roots, many=True)
        return Response(serializer.data)
    
    @action(detail=False, methods=['get'], permission_classes=[permissions.AllowAny])
    def roots(self, request):
        """Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ"""
        roots = Category.objects.roots()
        serializer = CategoryListSerializer(roots, many=True)
        return Response(serializer.data)
    
    @action(detail=True, methods=['get'])
    def children(self, request, pk=None):
        """ÙØ±Ø²Ù†Ø¯Ø§Ù† ÛŒÚ© Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ"""
        category = self.get_object()
        children = category.get_children().filter(is_active=True)
        serializer = CategoryListSerializer(children, many=True)
        return Response(serializer.data)
    
    @action(detail=True, methods=['post'])
    def add_child(self, request, pk=None):
        """Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø²ÛŒØ±Ø¯Ø³ØªÙ‡"""
        parent = self.get_object()
        serializer = CategoryCreateUpdateSerializer(data=request.data)
        
        if serializer.is_valid():
            with transaction.atomic():
                child = parent.add_child(**serializer.validated_data)
                Category.objects.clear_cache()
                
            return Response(
                CategoryDetailSerializer(child).data, 
                status=status.HTTP_201_CREATED
            )
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
    
    @action(detail=True, methods=['post'])
    def move(self, request, pk=None):
        """Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ"""
        category = self.get_object()
        target_id = request.data.get('target_id')
        position = request.data.get('position', 'last-child')
        
        if not target_id:
            return Response(
                {'error': 'target_id is required'}, 
                status=status.HTTP_400_BAD_REQUEST
            )
        
        target = get_object_or_404(Category, id=target_id)
        
        # Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ Ø¨Ù‡ Ø®ÙˆØ¯ ÛŒØ§ ÙØ±Ø²Ù†Ø¯Ø§Ù†
        if target.is_descendant_of(category) or target == category:
            return Response(
                {'error': 'Cannot move to self or descendant'}, 
                status=status.HTTP_400_BAD_REQUEST
            )
        
        try:
            with transaction.atomic():
                category.move(target, pos=position)
                Category.objects.clear_cache()
            
            return Response({'status': 'moved successfully'})
        except Exception as e:
            return Response(
                {'error': str(e)}, 
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )
    
    def destroy(self, request, *args, **kwargs):
        """Ø­Ø°Ù Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ"""
        category = self.get_object()
        
        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ÙØ±Ø²Ù†Ø¯
        if category.get_children_count() > 0:
            return Response(
                {'error': 'Cannot delete category with children'}, 
                status=status.HTTP_400_BAD_REQUEST
            )
        
        with transaction.atomic():
            category.delete()
            Category.objects.clear_cache()
        
        return Response(status=status.HTTP_204_NO_CONTENT)
```

---

## ğŸ—„ï¸ Cache Management

```python
# categories/cache_utils.py
from django.core.cache import cache
from django.db.models.signals import post_save, post_delete
from django.dispatch import receiver

class CategoryCache:
    TREE_KEY = 'category_tree_data'
    ROOTS_KEY = 'category_roots'
    TIMEOUT = 3600  # 1 hour
    
    @classmethod
    def get_tree(cls):
        return cache.get(cls.TREE_KEY)
    
    @classmethod
    def set_tree(cls, data):
        cache.set(cls.TREE_KEY, data, cls.TIMEOUT)
    
    @classmethod
    def clear_all(cls):
        cache.delete_many([cls.TREE_KEY, cls.ROOTS_KEY])

# categories/signals.py
from django.db.models.signals import post_save, post_delete
from django.dispatch import receiver
from .models import Category
from .cache_utils import CategoryCache

@receiver([post_save, post_delete], sender=Category)
def clear_category_cache(sender, instance, **kwargs):
    """Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø´ Ù‡Ù†Ú¯Ø§Ù… ØªØºÛŒÛŒØ±"""
    CategoryCache.clear_all()
    # Ø§Ú¯Ø± Ø§Ø² Redis Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯
    # from django_redis import get_redis_connection
    # redis_conn = get_redis_connection("default")
    # redis_conn.delete("category:*")
```

---

## ğŸ”’ URLs

```python
# categories/urls.py
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import CategoryViewSet

router = DefaultRouter()
router.register(r'categories', CategoryViewSet, basename='category')

urlpatterns = [
    path('api/v1/', include(router.urls)),
]

# Ø¯Ø± main urls.py
from django.urls import path, include

urlpatterns = [
    path('', include('categories.urls')),
]
```

---

## âš¡ Performance & Security Checklist

### âœ… Database
- [x] Index Ø±ÙˆÛŒ `path`, `is_active+path`, `slug`
- [x] Constraints Ø¨Ø±Ø§ÛŒ data integrity
- [x] Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² `select_for_update()` Ø¯Ø± Ø¹Ù…Ù„ÛŒØ§Øª Ø­Ø³Ø§Ø³

### âœ… Cache
- [x] Redis cache Ø¨Ø±Ø§ÛŒ tree data
- [x] Signal handlers Ø¨Ø±Ø§ÛŒ clear cache
- [x] Cache timeout Ù…Ù†Ø§Ø³Ø¨ (1 hour)

### âœ… Security
- [x] Permission classes Ø¨Ø±Ø§ÛŒ API endpoints
- [x] Validation Ø¯Ø± serializers
- [x] Transaction wrapping Ø¨Ø±Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª Ù¾ÛŒÚ†ÛŒØ¯Ù‡
- [x] Input sanitization

### âœ… API Design
- [x] RESTful endpoints
- [x] Proper HTTP status codes
- [x] Error handling
- [x] Pagination ready (Ø§Ú¯Ø± Ù†ÛŒØ§Ø² Ø¨Ø§Ø´Ø¯)

---

## ğŸ§ª Migration Ùˆ Test

```bash
# Ø§ÛŒØ¬Ø§Ø¯ migrations
python manage.py makemigrations categories
python manage.py migrate

# ØªØ³Øª Ø³Ø±ÛŒØ¹ Ø¯Ø± shell
python manage.py shell
```

```python
# Test data
from categories.models import Category

# Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
electronics = Category.add_root(name="Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©", slug="electronics")
clothing = Category.add_root(name="Ù¾ÙˆØ´Ø§Ú©", slug="clothing")

# Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø²ÛŒØ±Ø¯Ø³ØªÙ‡
mobile = electronics.add_child(name="Ù…ÙˆØ¨Ø§ÛŒÙ„", slug="mobile")
laptop = electronics.add_child(name="Ù„Ù¾â€ŒØªØ§Ù¾", slug="laptop")

# Ø²ÛŒØ±-Ø²ÛŒØ±Ø¯Ø³ØªÙ‡
android = mobile.add_child(name="Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯", slug="android")
iphone = mobile.add_child(name="Ø¢ÛŒÙÙˆÙ†", slug="iphone")

# ØªØ³Øª API
# GET /api/v1/categories/tree/
# GET /api/v1/categories/roots/
# POST /api/v1/categories/{id}/add_child/
```

---

## ğŸ“ Ù†Ú©Ø§Øª Ù…Ù‡Ù…

1. **Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø² `transaction.atomic()`** Ø¨Ø±Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª ØªØºÛŒÛŒØ± Ø¯Ø±Ø®Øª
2. **Clear cache** Ø¨Ø¹Ø¯ Ø§Ø² Ù‡Ø± ØªØºÛŒÛŒØ±
3. **Validation** Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø­Ù„Ù‚Ù‡ Ø¯Ø± Ø¯Ø±Ø®Øª
4. **Backup** Ù‚Ø¨Ù„ Ø§Ø² Ø¹Ù…Ù„ÛŒØ§Øª move Ø¨Ø²Ø±Ú¯
5. **Monitor performance** Ø¨Ø§ Django Debug Toolbar

---

**âœ¨ Ø§ÛŒÙ† Ø¯Ø§Ú©ÛŒÙˆÙ…Ù†Øª Ø¢Ù…Ø§Ø¯Ù‡ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¯Ø± Ù¾Ø±ÙˆÚ˜Ù‡ Ø§Ø³Øª**